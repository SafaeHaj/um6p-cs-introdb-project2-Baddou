Enter password: ****
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 32
Server version: 8.0.34 MySQL Community Server - GPL

Copyright (c) 2000, 2023, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> USE LogDatabase;
Database changed
mysql> CREATE ROLE 'user', 'airline', 'admin';
Query OK, 0 rows affected (0.69 sec)

mysql> GRANT ALL ON project2.Flight  TO 'airline';
Query OK, 0 rows affected (0.12 sec)

mysql> GRANT ALL ON project2.Airplane  TO 'airline';
Query OK, 0 rows affected (0.09 sec)

mysql> GRANT SELECT ON project2.Checks TO 'admin';
Query OK, 0 rows affected (0.15 sec)

mysql> GRANT ALL ON project2.Reservation TO 'admin';
Query OK, 0 rows affected (0.07 sec)

mysql> GRANT SELECT ON project2.Flight TO 'user';
Query OK, 0 rows affected (0.06 sec)

mysql> DELIMITER //
mysql> CREATE PROCEDURE CreateReservationView(IN user_email VARCHAR(32))
    -> BEGIN
    ->     DECLARE view_name VARCHAR(46);
    ->     DECLARE sql_query VARCHAR(164);
    ->     DECLARE grant_query VARCHAR(86);
    ->
    ->     SET @view_name = CONCAT(SUBSTRING_INDEX(user_email, '@', 1), 'ReservationView');
    ->     SET @sql_query = CONCAT('CREATE VIEW ', @view_name, ' AS
    '>         SELECT rid, rdate, confirmDate
    '>         FROM Reservation
    '>         JOIN User
    '>         ON Reservation.uemail = User.uemail
    '>         WHERE User.uemail = ', QUOTE(user_email));
    ->
    ->     PREPARE stmt FROM @sql_query;
    ->     EXECUTE stmt;
    ->     DEALLOCATE PREPARE stmt;
    ->
    ->     SET @grant_query = CONCAT('GRANT INSERT, UPDATE, DELETE ON project2.', @view_name, ' TO `user`');
    ->     PREPARE stmt FROM @grant_query;
    ->     EXECUTE stmt;
    ->     DEALLOCATE PREPARE stmt;
    -> END //
Query OK, 0 rows affected (0.22 sec)

mysql> CREATE PROCEDURE CreatePassengerView(IN user_email VARCHAR(32))
    -> BEGIN
    ->  DECLARE view_name VARCHAR(46);
    ->         DECLARE sql_query VARCHAR(164);
    ->         DECLARE grant_query VARCHAR(86);
    ->  SET @view_name = CONCAT(SUBSTRING_INDEX(user_email, @, 1), 'PassengerView');
    ->  SET @sql_query = CONCAT('CREATE VIEW', @view_name, 'AS
    '>  CREATE VIEW PassengerView AS
    '>  SELECT passportID, cin, pfirstName AS firstName, plastName AS lastName, phoneNumber, pbirthDate AS birthDate
    '>  FROM Passenger
    '>  JOIN Ticket ON Ticket.passportID = Passenger.passportID
    '>  JOIN Reservation ON Reservation.rid = Ticket.rid
    '>  JOIN User ON User.uemail = Reservation.uemail
    '>  WHERE User.uemail = ', QUOTE(user_email), ';');
    ->  PREPARE stmt FROM @sql_query;
    ->  EXECUTE stmt;
    ->  DEALLOCATE PREPARE stmt;
    ->
    ->  SET @grant_query = CONCAT('GRANT INSERT, UPDATE, DELETE ON project2.', @view_name, ' TO `user`');
    ->          PREPARE stmt FROM @grant_query;
    ->          EXECUTE stmt;
    ->          DEALLOCATE PREPARE stmt;
    -> END //
Query OK, 0 rows affected (0.18 sec)